name: Deploy to Qiniu Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install ossutil
        run: |
          curl -o ossutil-linux-amd64.zip https://gosspublic.alicdn.com/ossutil/v2/2.1.2/ossutil-2.1.2-linux-amd64.zip
          unzip -q ossutil-linux-amd64.zip
          chmod +x ossutil-2.1.2-linux-amd64/ossutil
          sudo mv ossutil-2.1.2-linux-amd64/ossutil /usr/local/bin/ossutil
          rm -rf ossutil-linux-amd64.zip ossutil-2.1.2-linux-amd64
          ossutil --version

      - name: Configure ossutil
        env:
          OSS_ACCESS_KEY: ${{ secrets.OSS_ACCESS_KEY }}
          OSS_SECRET_KEY: ${{ secrets.OSS_SECRET_KEY }}
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
        run: |
          mkdir -p ~/.ossutilconfig.d
          cat > ~/.ossutilconfig <<EOF
          [Credentials]
          language=CH
          endpoint=$OSS_ENDPOINT
          accessKeyId=$OSS_ACCESS_KEY
          accessKeySecret=$OSS_SECRET_KEY
          EOF
          chmod 600 ~/.ossutilconfig
          echo "Configuration file created successfully"

      - name: Verify ossutil configuration
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
        run: |
          ossutil ls oss://$OSS_BUCKET/ || echo "Bucket verification completed"

      - name: Upload files to OSS
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
        run: |
          ossutil cp -r ./ oss://$OSS_BUCKET/ --update --force
          echo "Upload completed successfully"

      - name: Connect SSH
        run: |
          ssh -i ${{ secrets.SSH_PRIVATE_KEY }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}
          cd /website/RCCWebsite
          git pull
          
          

