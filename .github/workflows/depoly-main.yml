name: Deploy to Qiniu Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install ossutil
        run: |
          # 下载 zip 包安装 (最可靠方式)
          wget -q https://gosspublic.alicdn.com/ossutil/1.7.19/ossutil-v1.7.19-linux-amd64.zip
          unzip -q ossutil-v1.7.19-linux-amd64.zip
          chmod +x ossutil-v1.7.19-linux-amd64/ossutil
          sudo mv ossutil-v1.7.19-linux-amd64/ossutil /usr/local/bin/
          rm -rf ossutil-v1.7.19-linux-amd64*
          ossutil --version

      - name: Configure ossutil
        env:
          OSS_ACCESS_KEY: ${{ secrets.OSS_ACCESS_KEY }}
          OSS_SECRET_KEY: ${{ secrets.OSS_SECRET_KEY }}
          OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
        run: |
          # 生成配置文件 (注意 v1 版本 accessKeyID 的 ID 为大写)
          mkdir -p ~/.ossutilconfig.d
          cat > ~/.ossutilconfig <<EOF
          [Credentials]
          language=CH
          endpoint=$OSS_ENDPOINT
          accessKeyID=$OSS_ACCESS_KEY
          accessKeySecret=$OSS_SECRET_KEY
          EOF
          chmod 600 ~/.ossutilconfig

      - name: Upload files to OSS
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
        run: |
          # -f 强制覆盖, -u 增量上传
          # 排除 .git 目录、GitHub workflows 配置、README 文件以及 ds_store
          ossutil cp -r -f -u ./ oss://$OSS_BUCKET/ \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "README.md" \
            --exclude ".DS_Store" \
            --exclude ".gitignore"
          echo "Upload completed successfully"

      - name: Connect SSH and Deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          # 配置 SSH 私钥
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # 添加主机指纹 (可选，避免交互式确认)
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts
          
          # 执行远程命令
          ssh -i ~/.ssh/id_rsa $SSH_USER@$SSH_HOST "cd /website/RCCWebsite && git pull"
          
          

